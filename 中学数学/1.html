import React, { useState, useEffect } from 'react';
import { ChevronRight, ChevronLeft, RefreshCw, Calculator, Info } from 'lucide-react';

const MathExplanation = () => {
  const [step, setStep] = useState(0);
  const [showFormula, setShowFormula] = useState(false);

  // ステップごとの解説データ
  const steps = [
    {
      title: "1. 最初の状態を確認",
      description: "まずは、おもりを入れる前の状態を確認しましょう。",
      details: [
        "容器Aは、底面の半径10cm、高さ10cmの円錐（逆さま）です。",
        "この容器は「高さ」と「半径」が常に同じ長さになります（直角二等辺三角形の回転体）。",
        "最初は、深さ9cmまで水が入っています。"
      ]
    },
    {
      title: "2. おもりを沈める",
      description: "半径4cmの円柱形のおもりを沈めます。",
      details: [
        "おもりはどこで止まるでしょうか？",
        "容器の壁にぶつかって止まります。",
        "容器は「高さ＝半径」の形なので、半径4cmのおもりは、ちょうど「高さ4cm」の場所で止まります。"
      ]
    },
    {
      title: "3. 水の状態を考える",
      description: "「おもりの底面と水面の高さが等しくなった」とは？",
      details: [
        "おもりの底面は高さ4cmの位置にあります。",
        "つまり、水面も高さ4cmになったということです。",
        "高さ4cmより上にあった水は、すべてあふれ出てしまいました。",
        "残っているのは、高さ4cmの円錐部分の水だけです。"
      ]
    },
    {
      title: "4. 計算して答えを出す",
      description: "あふれ出た水の体積を計算しましょう。",
      details: [
        "計算式：(最初の水) － (残った水) ＝ (あふれた水)",
        "それぞれの体積を求めて引き算します。"
      ]
    }
  ];

  const handleNext = () => {
    if (step < steps.length - 1) setStep(step + 1);
  };

  const handlePrev = () => {
    if (step > 0) setStep(step - 1);
  };

  const reset = () => {
    setStep(0);
    setShowFormula(false);
  };

  return (
    <div className="flex flex-col md:flex-row h-screen bg-gray-50 text-gray-800 font-sans">
      {/* 左側：解説パネル */}
      <div className="w-full md:w-1/2 p-6 flex flex-col justify-between shadow-lg bg-white z-10">
        <div>
          <h1 className="text-2xl font-bold text-blue-600 mb-2 flex items-center">
            <Calculator className="mr-2" />
            数学解説：あふれた水の体積
          </h1>
          <div className="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6">
            <h2 className="font-bold text-lg mb-1">{steps[step].title}</h2>
            <p className="text-gray-700">{steps[step].description}</p>
          </div>

          <div className="space-y-3 mb-6">
            {steps[step].details.map((detail, idx) => (
              <div key={idx} className="flex items-start animate-fade-in-up" style={{ animationDelay: `${idx * 100}ms` }}>
                <div className="bg-blue-100 text-blue-600 rounded-full p-1 mr-3 mt-1">
                  <Info size={16} />
                </div>
                <p className="leading-relaxed">{detail}</p>
              </div>
            ))}
          </div>

          {step === 3 && (
            <div className="bg-gray-100 p-4 rounded-lg border border-gray-300 transition-all duration-500 ease-in-out">
              <h3 className="font-bold border-b border-gray-300 pb-2 mb-3">計算のステップ</h3>
              
              <div className="space-y-4 font-mono text-sm md:text-base">
                <div className="flex flex-col">
                  <span className="text-gray-500 text-xs">① 最初の水の体積 (高さ9cm)</span>
                  <div className="flex items-center">
                    <span className="bg-blue-100 px-2 py-1 rounded">1/3 × π × 9² × 9</span>
                    <span className="mx-2">=</span>
                    <span className="font-bold text-blue-700">243π</span>
                  </div>
                </div>

                <div className="flex flex-col">
                  <span className="text-gray-500 text-xs">② 残った水の体積 (高さ4cm)</span>
                  <div className="flex items-center">
                    <span className="bg-blue-100 px-2 py-1 rounded">1/3 × π × 4² × 4</span>
                    <span className="mx-2">=</span>
                    <span className="font-bold text-blue-700">64/3 π</span>
                  </div>
                </div>

                <div className="flex flex-col pt-2 border-t border-gray-300">
                  <span className="text-gray-500 text-xs">③ 答え (引き算)</span>
                  <div className="flex items-center flex-wrap">
                    <span>243π - 64/3 π</span>
                    <span className="mx-2">=</span>
                    <span>(729/3 - 64/3)π</span>
                    <span className="mx-2">=</span>
                    <span className="font-bold text-xl text-red-600">665/3 π</span>
                    <span className="ml-1">cm³</span>
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>

        <div className="flex justify-between items-center mt-6 pt-4 border-t border-gray-200">
          <button 
            onClick={reset}
            className="flex items-center text-gray-500 hover:text-gray-700 transition-colors"
          >
            <RefreshCw size={18} className="mr-1" />
            はじめから
          </button>
          
          <div className="flex space-x-3">
            <button 
              onClick={handlePrev}
              disabled={step === 0}
              className={`flex items-center px-4 py-2 rounded-lg font-medium transition-all ${
                step === 0 
                  ? 'bg-gray-200 text-gray-400 cursor-not-allowed' 
                  : 'bg-white border border-gray-300 text-gray-700 hover:bg-gray-50'
              }`}
            >
              <ChevronLeft size={20} className="mr-1" />
              戻る
            </button>
            <button 
              onClick={handleNext}
              disabled={step === steps.length - 1}
              className={`flex items-center px-6 py-2 rounded-lg font-medium shadow-md transition-all ${
                step === steps.length - 1 
                  ? 'bg-gray-300 text-gray-500 cursor-not-allowed' 
                  : 'bg-blue-600 text-white hover:bg-blue-700 hover:shadow-lg'
              }`}
            >
              次へ
              <ChevronRight size={20} className="ml-1" />
            </button>
          </div>
        </div>
      </div>

      {/* 右側：ビジュアライザー */}
      <div className="w-full md:w-1/2 bg-blue-50 flex items-center justify-center p-4 relative overflow-hidden">
        <div className="absolute top-4 right-4 bg-white/80 p-2 rounded text-xs text-gray-500 z-10">
          図はイメージです
        </div>
        <Visualizer step={step} />
      </div>
    </div>
  );
};

// SVG描画コンポーネント
const Visualizer = ({ step }) => {
  // 座標変換定数 (SVG座標系: 600x500 に拡張して見切れを修正)
  // 円錐の底点(頂点)を (300, 400) とする
  // スケール: 1cm = 25px
  const originX = 300;
  const originY = 400;
  const scale = 25;

  // 円錐のパラメータ
  const coneHeight = 10 * scale; // 250px
  const coneRadius = 10 * scale; // 250px (width 500px) - これが収まるようにviewBoxを調整
  
  // 水のパラメータ
  // step 0,1: 高さ9cm
  // step 2,3: 高さ4cm (あふれた後)
  const waterHeightCm = (step >= 2) ? 4 : 9;
  const waterHeight = waterHeightCm * scale;
  const waterRadius = waterHeightCm * scale; // 半径=高さ

  // おもりのパラメータ
  const weightRadiusCm = 4;
  const weightRadius = weightRadiusCm * scale;
  const weightHeight = 400; // 十分長くして上部が見切れないように調整

  // おもりのY座標 (アニメーション用)
  // step 0: 上空に待機
  // step 1~3: 高さ4cmの位置に着底 (originY - 4*scale)
  const weightTargetY = originY - (4 * scale);
  const weightStartY = -150;
  
  const [currentWeightY, setCurrentWeightY] = useState(weightStartY);
  const [currentWaterH, setCurrentWaterH] = useState(9);

  useEffect(() => {
    if (step === 0) {
      setCurrentWeightY(weightStartY);
      setCurrentWaterH(9);
    } else if (step === 1) {
      setCurrentWeightY(weightTargetY);
      setCurrentWaterH(9);
    } else if (step >= 2) {
      setCurrentWeightY(weightTargetY);
      setCurrentWaterH(4);
    }
  }, [step]);

  // viewBoxを 0 0 600 500 に拡張
  return (
    <svg viewBox="0 0 600 500" className="w-full h-full max-w-[600px] max-h-[500px] drop-shadow-xl">
      <defs>
        <linearGradient id="waterGradient" x1="0" x2="0" y1="0" y2="1">
          <stop offset="0%" stopColor="#60A5FA" stopOpacity="0.6" />
          <stop offset="100%" stopColor="#3B82F6" stopOpacity="0.8" />
        </linearGradient>
        <marker id="arrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
          <path d="M0,0 L0,6 L9,3 z" fill="#666" />
        </marker>
      </defs>

      {/* 補助線: 地面 */}
      <line x1="0" y1={originY} x2="600" y2={originY} stroke="#E5E7EB" strokeWidth="2" />

      {/* 容器A (円錐) - 背面 */}
      <path 
        d={`M ${originX} ${originY} L ${originX - coneRadius} ${originY - coneHeight} L ${originX + coneRadius} ${originY - coneHeight} Z`}
        fill="none"
        stroke="#9CA3AF"
        strokeWidth="2"
      />
      {/* 容器Aの中心線 */}
      <line x1={originX} y1={originY} x2={originX} y2={originY - coneHeight} stroke="#D1D5DB" strokeDasharray="4 4" />

      {/* 水 (動的) */}
      <g style={{ transition: 'all 1s ease-in-out' }}>
        <path 
          d={`M ${originX} ${originY} 
              L ${originX - (currentWaterH * scale)} ${originY - (currentWaterH * scale)} 
              L ${originX + (currentWaterH * scale)} ${originY - (currentWaterH * scale)} Z`}
          fill="url(#waterGradient)"
        />
        {/* 水面ライン */}
        <line 
          x1={originX - (currentWaterH * scale)} 
          y1={originY - (currentWaterH * scale)} 
          x2={originX + (currentWaterH * scale)} 
          y2={originY - (currentWaterH * scale)} 
          stroke="#2563EB" 
          strokeWidth="1.5"
          strokeDasharray="2 2"
        />
      </g>

      {/* おもり (円柱) - 動的 */}
      <g 
        style={{ 
          transform: `translateY(${currentWeightY}px)`, 
          transition: 'transform 1s cubic-bezier(0.4, 0, 0.2, 1)' 
        }}
      >
        <rect 
          x={originX - weightRadius} 
          y={-weightHeight} 
          width={weightRadius * 2} 
          height={weightHeight} 
          fill="#94A3B8" 
          opacity="0.8"
          stroke="#475569"
          strokeWidth="2"
        />
        {/* おもりの底面ライン */}
        <line 
          x1={originX - weightRadius} 
          y1={0} 
          x2={originX + weightRadius} 
          y2={0} 
          stroke="#334155" 
          strokeWidth="2" 
        />
      </g>

      {/* 容器A (円錐) - 前面（枠線のみ再描画して重なりを綺麗に見せる） */}
      <path 
        d={`M ${originX} ${originY} L ${originX - coneRadius} ${originY - coneHeight} M ${originX} ${originY} L ${originX + coneRadius} ${originY - coneHeight}`}
        fill="none"
        stroke="#4B5563"
        strokeWidth="3"
        strokeLinecap="round"
      />

      {/* ラベル類 */}
      {step === 0 && (
        <>
          <TextLabel x={originX + 100} y={originY - 225} text="深さ9cm" color="#2563EB" />
          <Arrow x1={originX + 90} y1={originY - 225} x2={originX + 10} y2={originY - 225} />
        </>
      )}

      {step >= 1 && (
        <>
          <TextLabel x={originX - 100} y={originY - 80} text="半径4cm" color="#475569" />
          <line x1={originX} y1={originY - 100} x2={originX - weightRadius} y2={originY - 100} stroke="#475569" markerEnd="url(#arrow)" />
          
          <TextLabel x={originX + 60} y={originY - 50} text="高さ4cmで止まる" color="#DC2626" bold />
        </>
      )}

      {step >= 2 && (
        <g className="animate-pulse">
           <TextLabel x={originX} y={originY - 10} text="残った水" color="#FFF" align="middle" fontSize="12" />
        </g>
      )}
      
      {/* あふれた水の表現（Step 2のみアニメーション的に表示、Step 3で消すか残すか） */}
      {step === 2 && (
        <g style={{ opacity: 0.6 }}>
           <path 
             d={`M ${originX - (9 * scale)} ${originY - (9 * scale)} 
                 L ${originX - (4 * scale)} ${originY - (4 * scale)}
                 L ${originX + (4 * scale)} ${originY - (4 * scale)}
                 L ${originX + (9 * scale)} ${originY - (9 * scale)} Z`}
             fill="none"
             stroke="#60A5FA"
             strokeDasharray="4 4"
           />
           <TextLabel x={originX + 120} y={originY - 150} text="この部分があふれる" color="#60A5FA" />
        </g>
      )}

    </svg>
  );
};

// SVG内のテキストラベル補助コンポーネント
const TextLabel = ({ x, y, text, color = "#000", fontSize = "14", align = "start", bold = false }) => (
  <text 
    x={x} 
    y={y} 
    fill={color} 
    fontSize={fontSize} 
    textAnchor={align} 
    fontFamily="sans-serif" 
    fontWeight={bold ? "bold" : "normal"}
    style={{ textShadow: "1px 1px 0px white" }}
  >
    {text}
  </text>
);

// 矢印補助コンポーネント
const Arrow = ({ x1, y1, x2, y2, color = "#666" }) => (
  <line x1={x1} y1={y1} x2={x2} y2={y2} stroke={color} strokeWidth="1.5" markerEnd="url(#arrow)" />
);

export default MathExplanation;
